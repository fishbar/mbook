<!DOCTYPE html>
<html manifest="manifest.appcache">
  <head>
      <meta charset="utf-8">
      <title>GitBook Editor</title>
      <style type="text/css">
        body {
          padding: 0px;
          margin: 0px;
          font-family: 'Helvetica', 'HanHei SC', 'PingFang SC', 'Helvetica Neue', 'STHeitiSC-Light', 'Arial', sans-serif;
          font-size: 14px;
          overflow: hidden;
        }
        ::-webkit-scrollbar-thumb {
          display: none;
        }
        .dragable {
          -webkit-app-region:drag;
          -webkit-user-select: none;
        }
        .titlebar {
          height: 20px;
          padding: 10px;
          background-color: #676767;
          color: #fff;
          position: relative;
          box-shadow: 0px 1px 2px #999;
        }
        .titlebar .title {
          font-weight: bold;
          font-size: 20px;
        }
        .titlebar .btns {
          display: block;
          position: absolute;
          right: 10px;
          top: 10px;
        }
        .titlebar .btns a {
          display: inline-block;
          width: 17px;
          height: 17px;
          -webkit-app-region: no-drag;
          margin-left: 8px;
        }
        .titlebar .btns a:hover {
          background-color: rgba(255,255,255, 0.2);
          border-radius: 2px;
        }
        .titlebar .btn_max {
          background: url(./imgs/btn_max.png) transparent 0px 0px;
        }
        .titlebar .btn_max:hover {
          background-image: url(./imgs/btn_max_hover.png)
        }
        .titlebar .btn_min {
          background: url(./imgs/btn_min.png) transparent 0px 0px;
        }
        .titlebar .btn_min:hover {
          background-image: url(./imgs/btn_min_hover.png)
        }
        .titlebar .btn_close {
          background: url(./imgs/btn_close.png) transparent 0px 0px;
        }
        .titlebar .btn_close:hover {
          background-image: url(./imgs/btn_close_hover.png)
        }
        #contextmenu {
          display: none;
          position: absolute;
          background: #fff;
          border: 1px solid #aaa;
          border-radius: 4px;
        }
        #contextmenu a {
          display: block;
          padding: 2px 10px;
        }
        #contextmenu a:hover {
            background: #e5e5e5;
        }
      </style>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  </head>
  <body>
    <div class="titlebar dragable">
      <span class="title">Mbook</span>
      <span class="btns">
        <a class="btn_min" onclick="action_min()">&nbsp;</a>
        <a class="btn_max" onclick="action_max()">&nbsp;</a>
        <a class="btn_close" onclick="action_close()">&nbsp;</a>
      </span>
    </div>
    <div id="container"></div>
    <div id="contextmenu"></div>
  </body>
  <script type="text/javascript">
    'use strict';
    (function () {
      const {ipcRenderer} = require('electron');
      const remote = require('electron').remote;
      const log = require('../lib/log');
      let lastApp;
      function router() {
        let hash = location.hash.substr(2);
        let url = require('url');
        /**
         * router {
         *     pathname: 路径
         *     query: 查询参数
         * }
         * @type {String}
         */
        let router = url.parse(hash, true);
        let path = require('path');

        if (lastApp) {
          lastApp.destroy();
        }
        log.debug('loading controller: ', router.pathname);
        let Controller;
        try {
          Controller = require(path.join(__dirname, '../controller', router.pathname));
        } catch (e) {
          log.error('loading controller error', e.stack);
        }
        try {
          log.debug('new controller: ', router.query);

          let options = {
            container: document.querySelector('#container')
          };
          Object.keys(router.query).forEach(function (k) {
            options[k] = router.query[k];
          });
          lastApp = new Controller(options);
          lastApp.resize && lastApp.resize();
          lastApp.on('scene', function (data) {
            ipcRenderer.sendSync('scene', data);
          });
        } catch (e) {
          log.error('init controller error', e.stack);
        }
      }
      window.addEventListener('resize', function () {
        // let w = window.document.documentElement.clientWidth;
        // let h = window.document.documentElement.clientHeight;
        lastApp.resize && lastApp.resize();
      });
      window.addEventListener('hashchange', function () {
        log.debug('hashchange');
        router();
      }, false);
      window.addEventListener('keydown', function (e) {
        if (!e.metaKey && !e.ctrlKey) {
          return;
        }
        if (e.keyCode !== 73) {
          return;
        }
        ipcRenderer.sendSync('devtools');
      });

      window.action_close = function () {
        let win = remote.BrowserWindow.getFocusedWindow();
        win.close();
      };
      window.action_min = function () {
        let win = remote.BrowserWindow.getFocusedWindow();
        win.minimize();
      };
      window.action_max = function () {
        let win = remote.BrowserWindow.getFocusedWindow();
        if (win.isMaximized()) {
          win.unmaximize();
        } else {
          win.maximize();
        }
      };

      let clickCount = 0;
      document.querySelector('.titlebar').addEventListener('click', function () {
        clickCount++;
        setTimeout(function () {
          clickCount--;
        }, 300);
        if (clickCount > 1) {
          let win = remote.BrowserWindow.getFocusedWindow();
          if (win.isMaximized()) {
            win.unmaximize();
          } else {
            win.maximize();
          }
        }
      }, false);

      log.debug('init default app');
      router();
    })();
  </script>
</html>
